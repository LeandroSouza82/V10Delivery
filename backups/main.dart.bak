/* Backup of lib/main.dart created by Copilot on 2026-01-23 */

// Conte√∫do copiado de lib/main.dart neste ponto de restaura√ß√£o
// Se necess√°rio, restaure substituindo lib/main.dart por este arquivo.

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:wakelock_plus/wakelock_plus.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:intl/intl.dart';
import 'package:map_launcher/map_launcher.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:io';
import 'package:image_picker/image_picker.dart';
import 'package:path_provider/path_provider.dart';
import 'package:path/path.dart' as p;
import 'package:audioplayers/audioplayers.dart';
import 'package:share_plus/share_plus.dart';

// N√∫mero do gestor (formato internacional sem +). Configure aqui.
const String numeroGestor = '5548996525008';
const String prefSelectedMapKey = 'selected_map_app';

// Modelo simples para hist√≥rico de entregas
class ItemHistorico {
	final String nomeCliente;
	final String horario;
	final String status;
	final String? motivo;
	final String? caminhoFoto;
	final String? caminhoAssinatura;

	ItemHistorico({
		required this.nomeCliente,
		required this.horario,
		required this.status,
		this.motivo,
		this.caminhoFoto,
		this.caminhoAssinatura,
	});
}

final List<ItemHistorico> historicoEntregas = [];

Future<void> main() async {
	WidgetsFlutterBinding.ensureInitialized();
	WakelockPlus.enable();
	await SystemChrome.setPreferredOrientations([DeviceOrientation.portraitUp]);
	runApp(V10DeliveryApp());
}

class V10DeliveryApp extends StatelessWidget {
	const V10DeliveryApp({super.key});

	@override
	Widget build(BuildContext context) {
		return MaterialApp(
			debugShowCheckedModeBanner: false,
			theme: ThemeData.dark(),
			home: RotaMotorista(),
		);
	}
}

Future<void> _enviarWhatsApp(String mensagem, {String? phone}) async {
	// Construir Uri com `Uri` para garantir codifica√ß√£o correta
	Uri uri;
	if (phone != null && phone.isNotEmpty) {
		uri = Uri.https('api.whatsapp.com', '/send', {
			'phone': phone,
			'text': mensagem,
		});
	} else {
		uri = Uri.https('api.whatsapp.com', '/send', {'text': mensagem});
	}

	try {
		if (await canLaunchUrl(uri)) {
			await launchUrl(uri, mode: LaunchMode.externalApplication);
			return;
		}
	} catch (_) {}

	// fallback para esquema nativo do WhatsApp
	try {
		Uri whatsapp;
		if (phone != null && phone.isNotEmpty) {
			whatsapp = Uri(
				scheme: 'whatsapp',
				host: 'send',
				queryParameters: {'phone': phone, 'text': mensagem},
			);
		} else {
			whatsapp = Uri(
				scheme: 'whatsapp',
				host: 'send',
				queryParameters: {'text': mensagem},
			);
		}
		if (await canLaunchUrl(whatsapp)) {
			await launchUrl(whatsapp, mode: LaunchMode.externalApplication);
		}
	} catch (_) {}
}

class RotaMotorista extends StatefulWidget {
	const RotaMotorista({super.key});

	@override
	RotaMotoristaState createState() => RotaMotoristaState();
}

class RotaMotoristaState extends State<RotaMotorista>
		with SingleTickerProviderStateMixin {
	final String nomeMotorista = "LEANDRO";
	// signature modal and related session path removed
	String? caminhoFotoSession;
	XFile? fotoEvidencia;
	late AnimationController _buscarController;
	late Animation<double> _buscarOpacity;
	bool modoDia = false;
	int _esquemaCores = 0; // 0 = padr√£o, 1/2/3 = esquemas
	// hist√≥rico de itens finalizados (usar historicoEntregas global)
	// √çndices dos cards que est√£o sendo pressionados (efeito visual)
	final Set<int> _pressedIndices = {};

	// √Åudio: usar √∫nica inst√¢ncia para evitar consumo excessivo de mem√≥ria
	final AudioPlayer _audioPlayer = AudioPlayer();
	bool _searchingActive = false; // true quando anima√ß√£o de busca est√° ativa
	bool _awaitStartChama = false; // usado para iniciar loop ap√≥s som final

	// DADOS GARANTIDOS PARA N√ÉO FICAR VAZIO
	List<Map<String, String>> entregas = [
		{
			"id": "01",
			"cliente": "JO√ÉO SILVA",
			"endereco": "Rua Montenegro, 150",
			"tipo": "entrega",
			"obs": "Interfone com defeito.",
		},
		{
			"id": "02",
			"cliente": "MARIA OLIVEIRA",
			"endereco": "Av. dos Coqueiros, 890",
			"tipo": "recolha",
			"obs": "Cuidado com o cachorro.",
		},
		{
			"id": "03",
			"cliente": "LOG√çSTICA V10",
			"endereco": "Galp√£o Central",
			"tipo": "outros",
			"obs": "Retirar pacotes da tarde.",
		},
	];
	// CONTROLE DO MODAL DE SUCESSO (OK)
	final TextEditingController _nomeController = TextEditingController();
	final TextEditingController _aptController = TextEditingController();

	final List<String> _opcoesEntrega = [
		'PR√ìPRIO',
		'OUTROS',
		'ZELADOR',
		'S√çNDICO',
		'PORTEIRO',
		'FAXINEIRA',
		'MORADOR',
		'LOCKER',
		'CORREIO',
	];

	// removed unused _currentCardIndex
	// Caminho da foto de falha (usado pelo modal de FALHA)
	String? imagemFalha;
	// Motivo selecionado para falha (guardado no estado para reset/inspe√ß√£o)
	String? motivoFalhaSelecionada;
	// Contadores din√¢micos (iniciados com 0 por seguran√ßa de null-safety)
	int entregasFaltam = 0;
	int recolhasFaltam = 0;
	int outrosFaltam = 0;
	String? _selectedMapName;

	@override
	void initState() {
		super.initState();
		// Calcular contadores iniciais
		_atualizarContadores();
		// signature controller removed

		// anima√ß√£o de procura de rotas (opacidade pulsante)
		_buscarController = AnimationController(
			vsync: this,
			duration: Duration(seconds: 2),
		)..repeat(reverse: true);
		_buscarOpacity = Tween(begin: 0.3, end: 1.0).animate(
			CurvedAnimation(parent: _buscarController, curve: Curves.easeInOut),
		);

		// quando um som terminar, se sinalizado, iniciar o loop do 'chama.mp3'
		_audioPlayer.onPlayerComplete.listen((event) {
			if (_awaitStartChama) {
				_awaitStartChama = false;
				if (_searchingActive) _startChamaLoop();
			}
		});

		// Garantir configura√ß√µes iniciais do player
		try {
			_audioPlayer.setReleaseMode(ReleaseMode.stop);
			_audioPlayer.setVolume(1.0);
		} catch (_) {}

		// Carregar prefer√™ncia de app de mapa salvo
		SharedPreferences.getInstance().then((prefs) {
			final mapName = prefs.getString(prefSelectedMapKey);
			if (mapName != null && mapName.isNotEmpty) {
				setState(() => _selectedMapName = mapName);
			}
		});
	}

	@override
	void dispose() {
		_buscarController.dispose();
		_audioPlayer.dispose();
		_nomeController.dispose();
		_aptController.dispose();
		super.dispose();
	}

	// TOOLS DE √ÅUDIO
	// ignore: unused_element
	void _ensureAudioPlayer() {
		// agora _audioPlayer √© final e inicializado na declara√ß√£o, nada a fazer
	}

	// √önica fun√ß√£o de modal: `_buildSuccessModal` definida abaixo

	// antigos controles removidos

	// _finalizeDelivery removido (n√£o referenciado)

	// removed unused helper that built WhatsApp message

	// Novas fun√ß√µes de √°udio conforme especifica√ß√£o
	Future<void> _tocarSomFalha() async {
		try {
			await _audioPlayer.setVolume(1.0);
			await _audioPlayer.stop();
			// IMPORTANTE: arquivos de √°udio devem ficar em assets/audios/ e
			// serem registrados em pubspec.yaml. Evite alterar esse caminho.
			await _audioPlayer.play(AssetSource('audios/falha_3.mp3'));
			Future.delayed(Duration(seconds: 3), () async {
				try {
					await _audioPlayer.stop();
				} catch (_) {}
			});
		} catch (_) {}
	}

	Future<void> _tocarSomSucesso() async {
		try {
			await _audioPlayer.setVolume(1.0);
			await _audioPlayer.stop();
			// IMPORTANTE: arquivos de √°udio devem ficar em assets/audios/ e
			// serem registrados em pubspec.yaml. Evite alterar esse caminho.
			await _audioPlayer.play(AssetSource('audios/sucesso.mp3'));
		} catch (_) {}
	}

	Future<void> _tocarSomRotaConcluida() async {
		try {
			await _audioPlayer.setVolume(1.0);
			await _audioPlayer.stop();
			// IMPORTANTE: arquivos de √°udio devem ficar em assets/audios/ e
			// serem registrados em pubspec.yaml. Evite alterar esse caminho.
			await _audioPlayer.play(AssetSource('audios/final.mp3'));
		} catch (_) {}
	}

	// ignore: unused_element
	Future<void> _tocarSomNovoPedido() async {
		try {
			await _audioPlayer.setVolume(1.0);
			await _audioPlayer.stop();
			// IMPORTANTE: arquivos de √°udio devem ficar em assets/audios/ e
			// serem registrados em pubspec.yaml. Evite alterar esse caminho.
			await _audioPlayer.play(AssetSource('audios/chama.mp3'));
			Future.delayed(Duration(seconds: 2), () async {
				try {
					await _audioPlayer.stop();
				} catch (_) {}
			});
		} catch (_) {}
	}

	// Fun√ß√£o que inicia loop do som de chamada (se ainda desejar loop cont√≠nuo)
	Future<void> _startChamaLoop() async {
		try {
			await _audioPlayer.setVolume(1.0);
			await _audioPlayer.stop();
			await _audioPlayer.setReleaseMode(ReleaseMode.loop);
			// IMPORTANTE: arquivos de √°udio devem ficar em assets/audios/ e
			// serem registrados em pubspec.yaml. Evite alterar esse caminho.
			await _audioPlayer.play(AssetSource('audios/chama.mp3'));
		} catch (_) {}
	}

	// Parar qualquer √°udio em reprodu√ß√£o
	Future<void> _pararAudio() async {
		try {
			_awaitStartChama = false;
			await _audioPlayer.stop();
			try {
				await _audioPlayer.setReleaseMode(ReleaseMode.stop);
			} catch (_) {}
		} catch (_) {}
	}

	// Envia relat√≥rio de falha para o gestor, toca som, remove o card e fecha modal
	Future<void> _enviarFalha(
		String cardId,
		String cliente,
		String endereco,
		String motivoFinal,
	) async {
		final hora = DateFormat('HH:mm').format(DateTime.now());
		final hasPhoto = imagemFalha != null;

		final report =
				'‚ùå *RELAT√ìRIO DE FALHA*\n'
				'Status: N√£o Realizada\n'
				'Motivo: $motivoFinal\n'
				'Cliente: $cliente\n'
				'Endere√ßo: $endereco\n'
				'Motorista: LEANDRO\n'
				'Foto: ${hasPhoto ? '‚úÖ' : '‚ùå'}\n'
				'Hora: $hora';

		final wa = Uri.parse(
			'https://api.whatsapp.com/send?phone=$numeroGestor&text=${Uri.encodeComponent(report)}',
		);

		try {
			if (await canLaunchUrl(wa)) {
				await launchUrl(wa, mode: LaunchMode.externalApplication);
			}
		} catch (e) {
			// ignorar falha ao abrir WhatsApp
		}

		// Parar qualquer som de fundo antes de remover
		try {
			await _pararAudio();
		} catch (e) {
			// ignorar
		}

		setState(() {
			entregas.removeWhere((c) => c['id'] == cardId);
			imagemFalha = null;
			motivoFalhaSelecionada = null;
		});

		// Se n√£o h√° mais entregas, tocar som de rota conclu√≠da
		if (entregas.isEmpty) {
			setState(() => _searchingActive = false);
			try {
				await _tocarSomRotaConcluida();
			} catch (e) {
				// ignorar
			}
		}

		if (!mounted) return;
		final navigator = Navigator.of(context);
		navigator.pop();
	}

	Future<void> _salvarMapaSelecionado(String mapName) async {
		final prefs = await SharedPreferences.getInstance();
		await prefs.setString(prefSelectedMapKey, mapName);
		setState(() => _selectedMapName = mapName);
	}

	// √önica fun√ß√£o de modal: abre o bottom sheet de sucesso
	void _buildSuccessModal(BuildContext ctx, String nomeCliente) {
		// trava local iniciada como nula
		String? opcaoSelecionada;
		String obsTexto = '';

		showModalBottomSheet(
			context: ctx,
			isScrollControlled: true,
			backgroundColor: Colors.blueGrey[900],
			shape: RoundedRectangleBorder(
				borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
			),
			builder: (context) {
				return StatefulBuilder(
					builder: (context, setModalState) {
						return Padding(
							padding: EdgeInsets.only(
								left: 20,
								right: 20,
								top: 20,
								bottom: MediaQuery.of(context).viewInsets.bottom + 20,
							),
							child: SingleChildScrollView(
								child: Column(
									mainAxisSize: MainAxisSize.min,
									crossAxisAlignment: CrossAxisAlignment.stretch,
									children: [
										Text(
											'CONFIRMAR ENTREGA',
											style: TextStyle(
												fontSize: 20,
												fontWeight: FontWeight.bold,
												color: Colors.white,
											),
											textAlign: TextAlign.center,
										),
										SizedBox(height: 12),
										Text(
											'Como foi entregue? (selecione uma op√ß√£o)',
											style: TextStyle(color: Colors.white70),
										),
										SizedBox(height: 12),
										Wrap(
											spacing: 8,
											runSpacing: 8,
											children: _opcoesEntrega.map((opcao) {
												final selected = opcaoSelecionada == opcao;
												return ChoiceChip(
													label: Text(opcao),
													selected: selected,
													onSelected: (sel) => setModalState(() {
														opcaoSelecionada = sel ? opcao : null;
													}),
													selectedColor: Colors.blueGrey[700],
													backgroundColor: Colors.white10,
													labelStyle: TextStyle(color: Colors.white),
												);
											}).toList(),
										),
										SizedBox(height: 12),
										TextField(
											decoration: InputDecoration(
												labelText: 'Observa√ß√µes (opcional)',
												filled: true,
												fillColor: Colors.white10,
												border: OutlineInputBorder(),
												labelStyle: TextStyle(color: Colors.white70),
											),
											style: TextStyle(color: Colors.white),
											onChanged: (v) => setModalState(() => obsTexto = v),
											maxLines: 3,
										),
										SizedBox(height: 16),
										ElevatedButton(
											onPressed: opcaoSelecionada == null
													? null
													: () async {
															final navigator = Navigator.of(ctx);
															await _audioPlayer.stop();
															await _tocarSomSucesso();
															await Future.delayed(Duration(milliseconds: 500));

															final hora = DateFormat(
																'HH:mm',
															).format(DateTime.now());
															final mensagem =
																	'üì¶ ENTREGA: $nomeCliente\nStatus: $opcaoSelecionada\nObserva√ß√µes: ${obsTexto.isNotEmpty ? obsTexto : '-'}\nMotorista: $nomeMotorista\nHora: $hora';

															try {
																// Tocar som de sucesso ao confirmar entrega
																try {
																	await _audioPlayer.setVolume(1.0);
																	// IMPORTANTE: arquivos de √°udio devem ficar em assets/audios/ e
																	// serem registrados em pubspec.yaml. Evite alterar esse caminho.
																	await _audioPlayer.play(AssetSource('audios/sucesso.mp3'));
																} catch (_) {}
																await Future.delayed(Duration(milliseconds: 500));
																await _enviarWhatsApp(
																	mensagem,
																	phone: numeroGestor,
																);
															} catch (_) {}

															final idx = entregas.indexWhere(
																(e) => (e['cliente'] ?? '') == nomeCliente,
															);
															if (idx != -1) {
																setState(() {
																	entregas.removeAt(idx);
																	_atualizarContadores();
																});
															}

															// Se n√£o h√° mais entregas, tocar som de rota conclu√≠da
															if (entregas.isEmpty) {
																try {
																	await _tocarSomRotaConcluida();
																} catch (_) {}
															}

															if (!mounted) return;
															navigator.pop();
														},
											style: ElevatedButton.styleFrom(
												backgroundColor: Colors.green,
												foregroundColor: Colors.white,
												minimumSize: Size(double.infinity, 52),
											),
											child: Text('ENVIAR PARA GESTOR'),
										),
									],
								),
							),
						);
					},
				);
			},
		);
	}

	Future<void> _abrirMapaComPreferencia(String endereco) async {
		final encoded = Uri.encodeComponent(endereco);
		final prefs = await SharedPreferences.getInstance();
		final sel = prefs.getString(prefSelectedMapKey) ?? '';

		// Tentar abrir esquema do app preferido
		Uri? uriToLaunch;

		if (sel.toLowerCase().contains('waze')) {
			uriToLaunch = Uri.parse('waze://?q=$encoded');
		} else if (sel.toLowerCase().contains('google') ||
				sel.toLowerCase().contains('maps')) {
			// tentar esquema nativo do Google Maps
			uriToLaunch = Uri.parse('comgooglemaps://?q=$encoded');
		} else if (sel.isNotEmpty) {
			// fallback gen√©rico: tentar mapa web com busca
			uriToLaunch = Uri.parse(
				'https://www.google.com/maps/search/?api=1&query=$encoded',
			);
		} else {
			// sem prefer√™ncia: tentar abrir primeiro app instalado ou fallback web
			final available = await MapLauncher.installedMaps;
			if (available.isNotEmpty) {
				final m = available.first;
				if (m.mapName.toLowerCase().contains('waze')) {
					uriToLaunch = Uri.parse('waze://?q=$encoded');
				} else if (m.mapName.toLowerCase().contains('google')) {
					uriToLaunch = Uri.parse('comgooglemaps://?q=$encoded');
				} else {
					uriToLaunch = Uri.parse(
						'https://www.google.com/maps/search/?api=1&query=$encoded',
					);
				}
			} else {
				uriToLaunch = Uri.parse(
					'https://www.google.com/maps/search/?api=1&query=$encoded',
				);
			}
		}

		// ignore: unnecessary_null_comparison
		if (uriToLaunch != null) {
			try {
				await launchUrl(uriToLaunch, mode: LaunchMode.externalApplication);
			} catch (_) {
				// fallback para web
				final web = Uri.parse(
					'https://www.google.com/maps/search/?api=1&query=$encoded',
				);
				await launchUrl(web, mode: LaunchMode.externalApplication);
			}
		}
	}

	Future<void> _abrirPreferenciasMapa() async {
		try {
			final available = await MapLauncher.installedMaps;
			if (!mounted) return;

			showModalBottomSheet(
				context: context,
				builder: (ctx) {
					return SafeArea(
						child: Column(
							mainAxisSize: MainAxisSize.min,
							children: [
								ListTile(
									title: Text('Usar mapa web (Google Maps)'),
									onTap: () {
										_salvarMapaSelecionado('google_maps');
										Navigator.of(ctx).pop();
									},
								),
								...available.map((m) {
									return ListTile(
										leading: Icon(Icons.map),
										title: Text(m.mapName),
										onTap: () {
											_salvarMapaSelecionado(m.mapName);
											Navigator.of(ctx).pop();
										},
									);
								}),
							],
						),
					);
				},
			);
		} catch (e) {
			// ignore
		}
	}

